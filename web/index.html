<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>System monitor</title>
</head>
<body>
  <div id="stat">
  </div>
  <div id="proba">
  </div>
<script src="lib/d3/d3.min.js"></script>
<script src="lib/cubism/cubism.v1.min.js"></script>
<script>
(function () {
var wsUri = "ws://"+window.location.hostname+":9007/";
var stat = document.getElementById("stat");
var ws = new WebSocket(wsUri);

var dataBuffer = [];

ws.onmessage = function (e) {
  var data = JSON.parse(e.data);

  stat.innerHTML = "<h1>CPU: "+data.cpu+"</h1>"

  data.timestamp = +(new Date());

  dataBuffer.push(data);

  if (dataBuffer.length > 1000) {
    dataBuffer = dataBuffer.slice(-1000);
  }
};

var context = cubism.context()
    .serverDelay(0)
    .clientDelay(0)
    .step(1e3)
    .size(960);

var cpuMetric = context.metric(function (start, stop, step, callback) {
  start = +start;
  stop = +stop;
  values = dataBuffer.filter(function (data) {
    return data.timestamp >= start && data.timestamp <= stop;
  }).map(function (data) { return data.cpu; });

  callback(null, values);
}, "cpu");

var cpu = cpuMetric;

d3.select("#proba").call(function(div) {

  div.append("div")
      .attr("class", "axis")
      .call(context.axis().orient("top"));

  div.selectAll(".horizon")
      .data([cpu])
    .enter().append("div")
      .attr("class", "horizon")
      .call(context.horizon()
        .extent([0, 100])
        .height(120)
        .colors(["green", "green", "green", "green", "green", "blue", "yellow", "red"])
      );

  div.append("div")
      .attr("class", "rule")
      .call(context.rule());

});

context.on("focus", function(i) {
  d3.selectAll(".value").style("right", i == null ? null : context.size() - i + "px");
});

}());
</script>
</body>
</html>
